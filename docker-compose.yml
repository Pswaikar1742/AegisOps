version: '3.8'

networks:
  aegis-network:
    driver: bridge

services:
  # ── Target Application ─────────────────────────────────────────────
  buggy-app-v2:
    build:
      context: ./aegis_infra
    container_name: buggy-app-v2
    ports:
      - "8000:8000"
    networks:
      - aegis-network
    restart: unless-stopped

  # ── Nginx Load Balancer (Omnipotence) ──────────────────────────────
  aegis-lb:
    build:
      context: ./aegis_lb
    container_name: aegis-lb
    ports:
      - "80:80"
    networks:
      - aegis-network
    depends_on:
      - buggy-app-v2
    restart: unless-stopped

  # ── AegisOps Agent Core (GOD MODE Backend) ─────────────────────────
  aegis-agent:
    build:
      context: ./aegis_core
    container_name: aegis-agent
    ports:
      - "8001:8001"
    networks:
      - aegis-network
    extra_hosts:
      - "host.docker.internal:host-gateway"
    env_file: ./aegis_core/.env
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./aegis_core/data:/app/data  # persist runbook and agent data across restarts
    depends_on:
      - buggy-app-v2
      - aegis-lb
    restart: unless-stopped

  # ── SRE Cockpit (React UI – Omniscience) ───────────────────────────
  aegis-cockpit:
    build:
      context: ./aegis_cockpit
    container_name: aegis-cockpit
    ports:
      - "3000:3000"
    networks:
      - aegis-network
    depends_on:
      - aegis-agent
    restart: unless-stopped

  # ── Legacy Streamlit Dashboard (kept for backwards compat) ─────────
  aegis-dashboard:
    build:
      context: ./aegis_dashboard
    container_name: aegis-dashboard
    ports:
      - "8501:8501"
    networks:
      - aegis-network
    depends_on:
      - aegis-agent
    restart: unless-stopped
